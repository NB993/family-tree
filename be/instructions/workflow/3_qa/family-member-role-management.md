# Family 구성원 권한 관리 기능 QA 테스트 계획

> 공통 QA 프로세스는 [QA 가이드라인](./_qa-guidelines.md)을 참고하세요.

## 기능별 테스트 케이스

### 1. FamilyMemberRole 및 권한 시스템 테스트

#### 1.1 권한별 접근 제어 테스트
**테스트 케이스 1-1: OWNER 권한 검증**
- **API**: 모든 Family 관련 API
- **목적**: OWNER는 모든 권한을 가져야 함
- **전제 조건**: Family가 생성되고 OWNER가 할당됨
- **테스트 시나리오**:
  1. OWNER로 로그인
  2. 모든 Family 관련 기능에 접근 시도
  3. 모든 기능이 정상 동작하는지 확인
- **예상 결과**: 모든 기능 접근 가능 (Family 삭제, 권한 관리, 구성원 관리, 공지사항 관리)

**테스트 케이스 1-2: ADMIN 권한 검증**
- **목적**: ADMIN은 지정된 권한만 가져야 함
- **전제 조건**: ADMIN 권한을 부여받은 구성원이 존재
- **테스트 시나리오**:
  1. ADMIN으로 로그인
  2. 허용된 기능 접근 시도 (가입 신청 처리, 구성원 상태 관리, 공지사항 관리)
  3. 허용되지 않은 기능 접근 시도 (Family 삭제, 권한 관리)
- **예상 결과**: 허용된 기능만 접근 가능, 권한 없는 기능 접근 시 403 Forbidden

**테스트 케이스 1-3: MEMBER 권한 검증**
- **목적**: MEMBER는 조회 권한만 가져야 함
- **전제 조건**: 일반 MEMBER가 존재
- **테스트 시나리오**:
  1. MEMBER로 로그인
  2. 조회 기능 접근 시도 (Family 정보, 구성원 목록, 공지사항 조회)
  3. 관리 기능 접근 시도 (권한 변경, 구성원 관리, 공지사항 작성)
- **예상 결과**: 조회 기능만 접근 가능, 관리 기능 접근 시 403 Forbidden

#### 1.2 권한 상속 및 계층 구조 테스트
**테스트 케이스 1-4: 권한 계층 구조 검증**
- **목적**: OWNER > ADMIN > MEMBER 계층 구조가 올바르게 동작해야 함
- **테스트 시나리오**:
  1. OWNER가 ADMIN 권한을 가진 사용자의 상태 변경 시도
  2. ADMIN이 다른 ADMIN의 상태 변경 시도
  3. ADMIN이 MEMBER의 상태 변경 시도
- **예상 결과**: OWNER만 ADMIN 상태 변경 가능, ADMIN은 MEMBER만 관리 가능

### 2. 구성원 권한 관리 API 테스트

#### 2.1 권한 조회 기능 테스트
**테스트 케이스 2-1: 구성원 권한 목록 조회**
- **API**: `GET /api/families/{familyId}/members/roles`
- **목적**: 권한 있는 사용자만 구성원 권한을 조회할 수 있어야 함
- **테스트 시나리오**:
  1. OWNER/ADMIN으로 권한 목록 조회 API 호출
  2. MEMBER로 권한 목록 조회 API 호출
  3. 인증되지 않은 사용자로 API 호출
- **예상 결과**: OWNER/ADMIN만 조회 가능, MEMBER 및 인증되지 않은 사용자는 403/401 응답

**테스트 케이스 2-2: 응답 데이터 형식 검증**
- **목적**: API 응답이 명세서와 일치해야 함
- **테스트 시나리오**:
  1. 권한 목록 조회 API 호출
  2. 응답 JSON 구조 검증
  3. 필수 필드 존재 여부 확인 (id, userId, name, profileUrl, role)
- **예상 결과**: 명세서의 JSON 형식과 정확히 일치

#### 2.2 권한 변경 기능 테스트
**테스트 케이스 2-3: 정상적인 권한 변경**
- **API**: `PATCH /api/families/{familyId}/members/{memberId}/role`
- **목적**: OWNER가 다른 구성원의 권한을 올바르게 변경할 수 있어야 함
- **테스트 시나리오**:
  1. OWNER로 로그인
  2. MEMBER를 ADMIN으로 승격
  3. ADMIN을 MEMBER로 강등
- **예상 결과**: 권한 변경 성공, 데이터베이스에 올바르게 반영

**테스트 케이스 2-4: 권한 변경 제약 조건 검증**
- **목적**: 비즈니스 규칙에 따른 제약 조건이 올바르게 동작해야 함
- **테스트 시나리오**:
  1. OWNER가 자신의 권한 변경 시도
  2. ADMIN이 다른 구성원의 권한 변경 시도
  3. OWNER를 다른 역할로 변경 시도
  4. 존재하지 않는 구성원의 권한 변경 시도
- **예상 결과**: 모든 시도에서 적절한 에러 응답 (400 Bad Request 또는 403 Forbidden)

### 3. 가입 신청 처리 기능 테스트

#### 3.1 가입 신청 목록 조회 테스트
**테스트 케이스 3-1: 신청 목록 조회 권한 검증**
- **API**: `GET /api/families/{familyId}/join-requests`
- **목적**: OWNER/ADMIN만 가입 신청을 조회할 수 있어야 함
- **테스트 시나리오**:
  1. OWNER/ADMIN으로 신청 목록 조회
  2. MEMBER로 신청 목록 조회 시도
- **예상 결과**: OWNER/ADMIN만 조회 가능

**테스트 케이스 3-2: 신청 상태별 필터링**
- **목적**: status 파라미터에 따른 필터링이 올바르게 동작해야 함
- **테스트 시나리오**:
  1. status=PENDING으로 조회
  2. status=APPROVED로 조회
  3. status=REJECTED로 조회
  4. status 없이 조회 (기본값 PENDING)
- **예상 결과**: 각 상태에 맞는 신청만 반환

#### 3.2 가입 신청 처리 테스트
**테스트 케이스 3-3: 가입 신청 승인 처리**
- **API**: `PATCH /api/families/{familyId}/join-requests/{requestId}`
- **목적**: 가입 신청 승인 시 FamilyMember가 올바르게 생성되어야 함
- **테스트 시나리오**:
  1. PENDING 상태의 가입 신청 승인
  2. FamilyMember 테이블에 새로운 레코드 생성 확인
  3. 기본 역할이 MEMBER로 설정되었는지 확인
- **예상 결과**: 가입 신청 상태 변경 + FamilyMember 생성

**테스트 케이스 3-4: 중복 처리 방지**
- **목적**: 이미 처리된 신청은 다시 처리할 수 없어야 함
- **테스트 시나리오**:
  1. 가입 신청 승인 처리
  2. 동일한 신청을 다시 승인 시도
  3. 동일한 신청을 거절 시도
- **예상 결과**: 중복 처리 시도 시 400 Bad Request

### 4. 구성원 상태 관리 기능 테스트

#### 4.1 상태 변경 기능 테스트
**테스트 케이스 4-1: 정상적인 상태 변경**
- **API**: `PATCH /api/families/{familyId}/members/{memberId}/status`
- **목적**: 권한 있는 사용자가 구성원 상태를 올바르게 변경할 수 있어야 함
- **테스트 시나리오**:
  1. ADMIN이 MEMBER 상태를 SUSPENDED로 변경
  2. OWNER가 ADMIN 상태를 SUSPENDED로 변경
  3. 상태 변경 이력이 올바르게 기록되는지 확인
- **예상 결과**: 상태 변경 성공 + 이력 기록

**테스트 케이스 4-2: 상태 변경 권한 제약**
- **목적**: 권한 계층에 따른 제약이 올바르게 동작해야 함
- **테스트 시나리오**:
  1. ADMIN이 다른 ADMIN 상태 변경 시도
  2. MEMBER가 다른 구성원 상태 변경 시도
  3. 사용자가 자신의 상태 변경 시도
- **예상 결과**: 모든 시도에서 403 Forbidden

#### 4.2 상태 변경 이력 조회 테스트
**테스트 케이스 4-3: 이력 조회 권한 및 데이터 검증**
- **API**: `GET /api/families/{familyId}/members/{memberId}/status-history`
- **목적**: 상태 변경 이력이 올바르게 기록되고 조회되어야 함
- **테스트 시나리오**:
  1. 구성원 상태를 여러 번 변경
  2. 상태 변경 이력 조회
  3. 이력 데이터의 정확성 검증 (시간 순서, 변경자 정보 등)
- **예상 결과**: 모든 변경 이력이 시간 순으로 정확히 기록됨

### 5. 공지사항 관리 기능 테스트

#### 5.1 공지사항 CRUD 테스트
**테스트 케이스 5-1: 공지사항 생성 권한 검증**
- **API**: `POST /api/families/{familyId}/announcements`
- **목적**: OWNER/ADMIN만 공지사항을 작성할 수 있어야 함
- **테스트 시나리오**:
  1. OWNER로 공지사항 작성
  2. ADMIN으로 공지사항 작성
  3. MEMBER로 공지사항 작성 시도
- **예상 결과**: OWNER/ADMIN만 작성 가능

**테스트 케이스 5-2: 공지사항 수정/삭제 권한**
- **API**: `PUT /api/families/{familyId}/announcements/{announcementId}`, `DELETE /api/families/{familyId}/announcements/{announcementId}`
- **목적**: 작성자 또는 OWNER만 수정/삭제할 수 있어야 함
- **테스트 시나리오**:
  1. 작성자가 자신의 공지사항 수정/삭제
  2. OWNER가 다른 사람의 공지사항 수정/삭제
  3. ADMIN이 다른 ADMIN의 공지사항 수정/삭제 시도
- **예상 결과**: 작성자 및 OWNER만 수정/삭제 가능

#### 5.2 공지사항 조회 테스트
**테스트 케이스 5-3: 페이징 기능 검증**
- **API**: `GET /api/families/{familyId}/announcements`
- **목적**: 페이징 파라미터가 올바르게 동작해야 함
- **테스트 시나리오**:
  1. 여러 개의 공지사항 생성 (20개 이상)
  2. 다양한 page, size 값으로 조회
  3. 응답의 페이징 정보 확인 (totalElements, totalPages, currentPage)
- **예상 결과**: 페이징 파라미터에 따른 올바른 데이터 반환

## 기능별 예상 버그 및 엣지 케이스

### 1. 동시성 관련 이슈
**버그 시나리오 1: 동시 권한 변경**
- **상황**: 두 명의 OWNER가 동시에 같은 사용자의 권한을 변경
- **예상 문제**: 데이터 불일치, 마지막 변경이 이전 변경을 덮어씀
- **해결 방안**: 낙관적 락(Optimistic Locking) 또는 비관적 락 적용
- **테스트 방법**: 동시에 같은 멤버의 권한 변경 요청을 보내고 결과 확인

**버그 시나리오 2: 동시 가입 신청 처리**
- **상황**: 두 명의 관리자가 동시에 같은 가입 신청을 처리
- **예상 문제**: 중복 처리, FamilyMember 중복 생성
- **해결 방안**: 데이터베이스 레벨 유니크 제약 조건 + 트랜잭션 격리
- **테스트 방법**: 동시에 같은 가입 신청 승인 요청을 보내고 FamilyMember 중복 생성 여부 확인

### 2. 데이터 무결성 이슈
**버그 시나리오 3: 고아 데이터 생성**
- **상황**: Family 삭제 시 관련 데이터 정리 누락
- **예상 문제**: FamilyMember, Announcement 등 고아 데이터 발생
- **해결 방안**: CASCADE 삭제 설정 또는 소프트 딜리트 적용
- **테스트 방법**: Family 삭제 후 관련 테이블에 데이터 잔존 여부 확인

**버그 시나리오 4: 권한 승급 후 즉시 기능 사용**
- **상황**: MEMBER에서 ADMIN으로 승급 직후 관리 기능 사용
- **예상 문제**: 캐시 미반영으로 인한 권한 인식 오류
- **해결 방안**: 권한 변경 시 캐시 무효화 처리
- **테스트 방법**: 권한 변경 직후 새로운 세션으로 관리 기능 접근 시도

### 3. 비즈니스 로직 엣지 케이스
**엣지 케이스 1: Family에 OWNER만 존재하는 경우**
- **상황**: OWNER가 유일한 구성원일 때 자신을 강퇴 시도
- **예상 문제**: Family가 관리자 없는 상태가 됨
- **해결 방안**: OWNER가 유일한 구성원일 때는 상태 변경 금지
- **테스트 방법**: 단일 OWNER Family에서 자신의 상태 변경 시도

**엣지 케이스 2: 대량의 구성원 일괄 처리**
- **상황**: 수백 명의 구성원 권한을 동시에 변경
- **예상 문제**: 성능 저하, 타임아웃
- **해결 방안**: 배치 처리 또는 비동기 처리 적용
- **테스트 방법**: 대량 데이터로 부하 테스트 실행

**엣지 케이스 3: 순환 권한 참조**
- **상황**: A가 B를 ADMIN으로 승급 후, B가 A의 권한을 변경 시도
- **예상 문제**: 논리적 모순 상황
- **해결 방안**: OWNER 권한은 변경 불가 규칙 엄격 적용
- **테스트 방법**: ADMIN이 OWNER의 권한 변경 시도

### 4. 보안 관련 이슈
**보안 이슈 1: 권한 우회 시도**
- **상황**: URL 직접 접근, 토큰 조작 등을 통한 권한 우회
- **예상 문제**: 무권한 사용자의 민감한 기능 접근
- **해결 방안**: API 레벨에서 이중 권한 검증
- **테스트 방법**: 
  - MEMBER 토큰으로 ADMIN 전용 API 직접 호출
  - 다른 Family의 권한 관리 API 접근 시도
  - 만료된 토큰으로 API 접근 시도

**보안 이슈 2: 정보 노출**
- **상황**: 에러 메시지에 민감한 시스템 정보 포함
- **예상 문제**: 시스템 구조 노출, 보안 위험
- **해결 방안**: 일반화된 에러 메시지 사용
- **테스트 방법**: 
  - 잘못된 요청으로 에러 발생시켜 메시지 내용 확인
  - SQL 인젝션 시도하여 데이터베이스 정보 노출 여부 확인

## 기능별 성능 요구사항

### 1. 권한 관리 API 성능 기준
- **권한 목록 조회**: 100ms 이하 (구성원 100명 기준)
- **권한 변경**: 200ms 이하
- **동시 요청 처리**: 50개 동시 요청 시 에러율 1% 이하

### 2. 가입 신청 처리 성능 기준
- **신청 목록 조회**: 150ms 이하 (신청 500건 기준)
- **신청 처리**: 300ms 이하 (FamilyMember 생성 포함)
- **대량 신청 처리**: 100건 일괄 처리 시 30초 이내

### 3. 상태 관리 성능 기준
- **상태 변경**: 200ms 이하 (이력 기록 포함)
- **이력 조회**: 100ms 이하 (이력 100건 기준)
- **대량 상태 변경**: 50명 동시 상태 변경 시 10초 이내

### 4. 공지사항 관리 성능 기준
- **공지사항 목록 조회**: 100ms 이하 (공지 100건, 페이징 적용)
- **공지사항 생성**: 150ms 이하
- **공지사항 수정/삭제**: 100ms 이하

### 5. 대용량 데이터 성능 테스트
**테스트 데이터 규모**:
- Family: 1,000개
- FamilyMember: 100,000개 (평균 100명/Family)
- JoinRequest: 50,000개
- Announcement: 10,000개
- StatusHistory: 200,000개

**성능 기준**:
- 모든 조회 API: 1초 이하
- 생성/수정 API: 2초 이하
- 복잡한 조인 쿼리: 3초 이하

## 기능별 사용자 수용 테스트 시나리오

### 1. Family 관리자 시나리오 (OWNER)
**시나리오 1-1: 신규 Family 운영 시작**
1. Family 생성 및 기본 설정
2. 신뢰할 수 있는 구성원을 ADMIN으로 임명
3. 가입 신청 정책 설정 및 초기 구성원 승인
4. 첫 공지사항 작성 및 운영 규칙 안내

**시나리오 1-2: Family 확장 및 권한 위임**
1. 활발한 구성원을 추가 ADMIN으로 임명
2. 각 ADMIN의 역할 분담 및 책임 부여
3. 권한 변경 이력 모니터링
4. 문제 상황 발생 시 권한 회수 절차

### 2. Family 부관리자 시나리오 (ADMIN)
**시나리오 2-1: 일상적인 Family 관리**
1. 매일 가입 신청 검토 및 처리
2. 구성원 간 갈등 상황에서 중재 및 제재
3. 정기적인 공지사항 작성 및 소통
4. 비활성 구성원 관리

**시나리오 2-2: 권한 제한 상황 대응**
1. 다른 ADMIN과의 의견 충돌 시 OWNER와 상의
2. 자신의 권한 범위 내에서만 기능 사용
3. 권한 부족 시 적절한 에러 메시지 확인

### 3. 일반 구성원 시나리오 (MEMBER)
**시나리오 3-1: Family 정보 파악**
1. Family 기본 정보 및 구성원 목록 조회
2. 공지사항 확인 및 중요 정보 파악
3. 자신의 권한 범위 이해

**시나리오 3-2: 권한 제한 경험**
1. 관리 기능 접근 시도 시 적절한 제한 확인
2. 권한 없음을 알리는 명확한 메시지 확인
3. 필요 시 관리자에게 요청하는 방법 안내

### 4. 복합 시나리오
**시나리오 4-1: 관리자 부재 상황**
1. OWNER 장기 부재 시 ADMIN들의 자율적 관리
2. 중요한 결정 사항 발생 시 임시 대응 방안
3. OWNER 복귀 후 관리 권한 정상화

**시나리오 4-2: 대량 구성원 가입 상황**
1. 단기간 대량 가입 신청 발생
2. 여러 ADMIN이 분담하여 신청 처리
3. 처리 속도 및 시스템 안정성 확인

## 테스트 데이터 시나리오

### 1. 기본 테스트 데이터
```json
{
  "families": [
    {
      "id": 1,
      "name": "김씨 대가족",
      "memberCount": 15,
      "ownerCount": 1,
      "adminCount": 2,
      "memberCount": 12
    },
    {
      "id": 2,
      "name": "소규모 Family",
      "memberCount": 3,
      "ownerCount": 1,
      "adminCount": 0,
      "memberCount": 2
    }
  ],
  "joinRequests": [
    {"familyId": 1, "status": "PENDING", "count": 5},
    {"familyId": 1, "status": "APPROVED", "count": 20},
    {"familyId": 1, "status": "REJECTED", "count": 3}
  ],
  "announcements": [
    {"familyId": 1, "count": 10},
    {"familyId": 2, "count": 2}
  ]
}
```

### 2. 엣지 케이스 테스트 데이터
- **단일 구성원 Family**: OWNER만 존재하는 Family
- **대규모 Family**: 구성원 500명 이상
- **다중 ADMIN Family**: ADMIN이 10명 이상인 Family
- **비활성 Family**: 30일 이상 활동이 없는 Family

### 3. 성능 테스트 데이터
- **대용량 가입 신청**: 1,000건의 PENDING 신청
- **장기 이력**: 2년간의 상태 변경 이력
- **대량 공지사항**: 1,000개의 공지사항 (페이징 테스트용)

## 회귀 테스트 체크리스트

### 1. 권한 시스템 핵심 기능
- [ ] OWNER 권한으로 모든 기능 접근 가능
- [ ] ADMIN 권한으로 지정된 기능만 접근 가능
- [ ] MEMBER 권한으로 조회만 가능
- [ ] 권한 계층 구조 정상 동작
- [ ] 권한 변경 시 즉시 반영

### 2. API 기본 동작
- [ ] 모든 API 엔드포인트 정상 응답
- [ ] 인증/인가 정상 동작
- [ ] 에러 상황 시 적절한 HTTP 상태 코드 반환
- [ ] 요청/응답 JSON 형식 명세 준수

### 3. 데이터 무결성
- [ ] 권한 변경 시 데이터 일관성 유지
- [ ] 가입 신청 처리 시 FamilyMember 정상 생성
- [ ] 상태 변경 이력 정확히 기록
- [ ] 공지사항 CRUD 정상 동작

### 4. 성능 및 안정성
- [ ] 기준 응답 시간 내 처리
- [ ] 동시 요청 처리 시 데이터 무결성 유지
- [ ] 메모리 누수 없음
- [ ] 장시간 실행 시 안정성 유지

### 5. 보안
- [ ] 권한 우회 불가
- [ ] 민감 정보 노출 없음
- [ ] SQL 인젝션 등 보안 취약점 없음
- [ ] 적절한 에러 메시지 제공
