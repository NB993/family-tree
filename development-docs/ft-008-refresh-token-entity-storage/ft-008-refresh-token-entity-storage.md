# FT-008: RefreshToken ì—”í‹°í‹° ë° í† í° ì €ì¥ì†Œ êµ¬í˜„ ì™„ë£Œ

## ë¬¸ì„œ ì •ë³´
- **Story ID**: FT-008
- **Story ì œëª©**: RefreshToken ì—”í‹°í‹° ë° í† í° ì €ì¥ì†Œ êµ¬í˜„
- **êµ¬í˜„ ì¼ì**: 2025-06-08
- **êµ¬í˜„ì**: AI ê°œë°œì

---

## êµ¬í˜„ ê°œìš”
JWT ì¸ì¦ ì‹œìŠ¤í…œì˜ í•µì‹¬ êµ¬ì„±ìš”ì†Œì¸ RefreshToken ì—”í‹°í‹°ì™€ ì €ì¥ì†Œë¥¼ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤. ì´ëŠ” Access Token ê°±ì‹ ì„ ìœ„í•œ ì¥ê¸° í† í° ê´€ë¦¬ ì‹œìŠ¤í…œì˜ ê¸°ë°˜ì´ ë©ë‹ˆë‹¤.

## êµ¬í˜„ëœ ì£¼ìš” ì»´í¬ë„ŒíŠ¸

### ë„ë©”ì¸ ê°ì²´
- **RefreshToken**: JWT ë¦¬í”„ë ˆì‹œ í† í°ì„ ìœ„í•œ ë„ë©”ì¸ ì—”í‹°í‹°
  - ì‚¬ìš©ìë³„ ê³ ìœ  í† í° ê´€ë¦¬
  - í† í° ë§Œë£Œ ê²€ì¦ ë¡œì§ í¬í•¨
  - ë¶ˆë³€ ê°ì²´ë¡œ ì„¤ê³„í•˜ì—¬ ë°ì´í„° ë¬´ê²°ì„± ë³´ì¥

### ì• í”Œë¦¬ì¼€ì´ì…˜ ê³„ì¸µ

#### Command/Query ê°ì²´
- **FindRefreshTokenByUserIdQuery**: ì‚¬ìš©ì ID ê¸°ë°˜ í† í° ì¡°íšŒ
- **FindExpiredRefreshTokensQuery**: ë§Œë£Œëœ í† í° ì¼ê´„ ì¡°íšŒ (ë°°ì¹˜ ì‘ì—…ìš©)
- **SaveRefreshTokenCommand**: í† í° ì €ì¥ ë° ê°±ì‹ 
- **DeleteRefreshTokenCommand**: í† í° ì‚­ì œ (ë¡œê·¸ì•„ì›ƒ ì‹œ)

#### UseCase ì¸í„°í˜ì´ìŠ¤
- **FindRefreshTokenUseCase**: í† í° ì¡°íšŒ ìœ ìŠ¤ì¼€ì´ìŠ¤
- **SaveRefreshTokenUseCase**: í† í° ì €ì¥ ìœ ìŠ¤ì¼€ì´ìŠ¤  
- **DeleteRefreshTokenUseCase**: í† í° ì‚­ì œ ìœ ìŠ¤ì¼€ì´ìŠ¤

#### Service í´ë˜ìŠ¤
- **FindRefreshTokenService**: í† í° ì¡°íšŒ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
- **SaveRefreshTokenService**: í† í° ì €ì¥ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
- **DeleteRefreshTokenService**: í† í° ì‚­ì œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§

#### ì•„ì›ƒë°”ìš´ë“œ í¬íŠ¸
- **FindRefreshTokenPort**: í† í° ì¡°íšŒ í¬íŠ¸
- **SaveRefreshTokenPort**: í† í° ì €ì¥ í¬íŠ¸
- **DeleteRefreshTokenPort**: í† í° ì‚­ì œ í¬íŠ¸

### ì¸í”„ë¼ ê³„ì¸µ
- **RefreshTokenJpaEntity**: JPA ì—”í‹°í‹° (refresh_tokens í…Œì´ë¸”)
- **RefreshTokenJpaRepository**: Spring Data JPA ë¦¬í¬ì§€í† ë¦¬
- **RefreshTokenAdapter**: ì•„ì›ƒë°”ìš´ë“œ í¬íŠ¸ êµ¬í˜„ì²´

## ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ

### refresh_tokens í…Œì´ë¸”
```sql
CREATE TABLE refresh_tokens (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT NOT NULL,
    token_hash VARCHAR(255) NOT NULL,
    expires_at TIMESTAMP NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_user_id (user_id),
    INDEX idx_expires_at (expires_at)
);
```

### ì£¼ìš” ì„¤ê³„ íŠ¹ì§•
- **ì‚¬ìš©ìë‹¹ í•˜ë‚˜ì˜ í† í°**: `user_id`ì— UNIQUE ì œì•½ì¡°ê±´ìœ¼ë¡œ ì¤‘ë³µ ë°©ì§€
- **ë§Œë£Œ ê²€ìƒ‰ ìµœì í™”**: `expires_at` ì¸ë±ìŠ¤ë¡œ ë°°ì¹˜ ì‘ì—… ì„±ëŠ¥ í–¥ìƒ
- **ìë™ íƒ€ì„ìŠ¤íƒ¬í”„**: JPA `@PrePersist`, `@PreUpdate`ë¡œ ì‹œê°„ ê´€ë¦¬

## í•µì‹¬ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§

### í† í° Upsert ë™ì‘
```java
// ê¸°ì¡´ í† í°ì´ ìˆë‹¤ë©´ ì‚­ì œ í›„ ìƒˆë¡œ ì €ì¥ (Upsert ë™ì‘)
if (refreshToken.getId() == null && refreshTokenJpaRepository.existsByUserId(refreshToken.getUserId())) {
    refreshTokenJpaRepository.deleteByUserId(refreshToken.getUserId());
    refreshTokenJpaRepository.flush(); // ì¦‰ì‹œ ì‚­ì œ ë°˜ì˜
}
```

### í† í° ë§Œë£Œ ê²€ì¦
```java
public boolean isExpired(LocalDateTime currentDateTime) {
    Objects.requireNonNull(currentDateTime, "currentDateTime must not be null");
    return expiresAt.isBefore(currentDateTime);
}
```

### ë°°ì¹˜ ì‘ì—… ì§€ì›
```java
// ë§Œë£Œëœ í† í° ì¡°íšŒ
@Query("SELECT rt FROM RefreshTokenJpaEntity rt WHERE rt.expiresAt < :currentDateTime")
List<RefreshTokenJpaEntity> findExpiredTokens(@Param("currentDateTime") LocalDateTime currentDateTime);

// ë§Œë£Œëœ í† í° ì¼ê´„ ì‚­ì œ
@Modifying
@Query("DELETE FROM RefreshTokenJpaEntity rt WHERE rt.expiresAt < :currentDateTime")
int deleteExpiredTokens(@Param("currentDateTime") LocalDateTime currentDateTime);
```

## í…ŒìŠ¤íŠ¸ êµ¬í˜„

### ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ (11ê°œ í…ŒìŠ¤íŠ¸)
- **Command/Query ê°ì²´ í…ŒìŠ¤íŠ¸**: ìœ íš¨ì„± ê²€ì¦ ë¡œì§ í…ŒìŠ¤íŠ¸
- **Service í…ŒìŠ¤íŠ¸**: ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ë° í¬íŠ¸ í˜¸ì¶œ ê²€ì¦
- **Adapter í…ŒìŠ¤íŠ¸**: ë°ì´í„°ë² ì´ìŠ¤ ì—°ë™ ë° ë³€í™˜ ë¡œì§ ê²€ì¦

### í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€
- âœ… ì •ìƒ ì¼€ì´ìŠ¤: í† í° ìƒì„±, ì¡°íšŒ, ì‚­ì œ
- âœ… ì˜ˆì™¸ ì¼€ì´ìŠ¤: null íŒŒë¼ë¯¸í„°, ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì‚¬ìš©ì
- âœ… ê²½ê³„ ì¼€ì´ìŠ¤: ë§Œë£Œëœ í† í°, ì¤‘ë³µ í† í° ì²˜ë¦¬
- âœ… ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™: ì‚¬ìš©ìë‹¹ í•˜ë‚˜ì˜ í† í°, Upsert ë™ì‘

### ì£¼ìš” í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤
```java
@Test
@DisplayName("ê¸°ì¡´ ì‚¬ìš©ì í† í°ì´ ìˆì„ ë•Œ ìƒˆ í† í° ì €ì¥ ì‹œ ê¸°ì¡´ í† í°ì´ êµì²´ë©ë‹ˆë‹¤")
void save_replaces_existing_token_when_user_already_has_token() {
    // ì‚¬ìš©ìë‹¹ í•˜ë‚˜ì˜ í† í°ë§Œ ìœ ì§€ë˜ëŠ”ì§€ ê²€ì¦
}

@Test  
@DisplayName("ë§Œë£Œëœ í† í°ë“¤ì„ ì¡°íšŒ ì‹œ í† í° ëª©ë¡ì„ ë°˜í™˜í•©ë‹ˆë‹¤")
void find_expired_tokens_returns_expired_tokens_only() {
    // ë°°ì¹˜ ì‘ì—…ì„ ìœ„í•œ ë§Œë£Œ í† í° í•„í„°ë§ ê²€ì¦
}
```

## ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

### í† í° ë³´ì•ˆ
- **í† í° í•´ì‹œ ì €ì¥**: ì›ë³¸ í† í° ëŒ€ì‹  í•´ì‹œê°’ë§Œ DBì— ì €ì¥
- **í† í° ì •ë³´ ë³´í˜¸**: toString()ì—ì„œ í† í° í•´ì‹œë¥¼ `[PROTECTED]`ë¡œ ë§ˆìŠ¤í‚¹
- **ìë™ ë§Œë£Œ**: ë§Œë£Œ ì‹œê°„ ê¸°ë°˜ í† í° ìœ íš¨ì„± ê²€ì¦

### ë°ì´í„° ë³´ì•ˆ
- **ì‚¬ìš©ì ê²©ë¦¬**: ì‚¬ìš©ìë³„ í† í° ì ‘ê·¼ ì œí•œ
- **ìë™ ì •ë¦¬**: ë§Œë£Œëœ í† í° ë°°ì¹˜ ì‚­ì œë¡œ ì €ì¥ì†Œ ì •ë¦¬

## ì„±ëŠ¥ ìµœì í™”

### ë°ì´í„°ë² ì´ìŠ¤ ìµœì í™”
- **ì¸ë±ìŠ¤ í™œìš©**: `user_id` UNIQUE ì¸ë±ìŠ¤ë¡œ ë¹ ë¥¸ ì¡°íšŒ
- **ë§Œë£Œ í† í° ì¸ë±ìŠ¤**: `expires_at` ì¸ë±ìŠ¤ë¡œ ë°°ì¹˜ ì‘ì—… ìµœì í™”
- **ì¦‰ì‹œ ì‚­ì œ**: `flush()`ë¡œ Upsert ì‹œ ì¼ê´€ì„± ë³´ì¥

### ë©”ëª¨ë¦¬ ìµœì í™”
- **ë¶ˆë³€ ê°ì²´**: RefreshToken ë„ë©”ì¸ ê°ì²´ ë¶ˆë³€ì„±ìœ¼ë¡œ ì•ˆì „ì„± í™•ë³´
- **Optional í™œìš©**: null ëŒ€ì‹  Optionalë¡œ ëª…ì‹œì  ë¶€ì¬ í‘œí˜„

## í—¥ì‚¬ê³ ë‚  ì•„í‚¤í…ì²˜ ì¤€ìˆ˜

### í¬íŠ¸ì™€ ì–´ëŒ‘í„° ë¶„ë¦¬
- **ì¸ë°”ìš´ë“œ í¬íŠ¸**: UseCase ì¸í„°í˜ì´ìŠ¤ë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì§„ì…ì  ì •ì˜
- **ì•„ì›ƒë°”ìš´ë“œ í¬íŠ¸**: ì™¸ë¶€ ì €ì¥ì†Œ ì¶”ìƒí™”ë¡œ êµ¬í˜„ ì„¸ë¶€ì‚¬í•­ ë¶„ë¦¬
- **ì–´ëŒ‘í„°**: JPA êµ¬í˜„ì²´ë¡œ í¬íŠ¸ ì¸í„°í˜ì´ìŠ¤ êµ¬í˜„

### ì˜ì¡´ì„± ì—­ì „
- **ì½”ì–´ â†’ ì¸í”„ë¼**: ë„ë©”ì¸ì´ ì¸í”„ë¼ì— ì˜ì¡´í•˜ì§€ ì•ŠìŒ
- **í¬íŠ¸ ì¸í„°í˜ì´ìŠ¤**: ì½”ì–´ ê³„ì¸µì—ì„œ ì •ì˜, ì¸í”„ë¼ì—ì„œ êµ¬í˜„
- **ì˜ì¡´ì„± ì£¼ì…**: Spring Frameworkë¡œ ëŸ°íƒ€ì„ ì˜ì¡´ì„± í•´ê²°

## ì•Œë ¤ì§„ ì´ìŠˆ ë° ì œì•½ì‚¬í•­

### í˜„ì¬ ì œì•½ì‚¬í•­
- **ë‹¨ì¼ ì„œë²„ í™˜ê²½**: í˜„ì¬ëŠ” ë‹¨ì¼ ì„œë²„ í™˜ê²½ì„ ê°€ì •
- **í† í° ê°±ì‹  ë¯¸êµ¬í˜„**: í† í° ê°±ì‹  APIëŠ” FT-011ì—ì„œ êµ¬í˜„ ì˜ˆì •
- **ë°°ì¹˜ ìŠ¤ì¼€ì¤„ë§ ë¯¸í¬í•¨**: ë§Œë£Œ í† í° ì •ë¦¬ ìŠ¤ì¼€ì¤„ëŸ¬ëŠ” ë³„ë„ êµ¬í˜„ í•„ìš”

### í–¥í›„ ê°œì„ ì‚¬í•­
- **ë¶„ì‚° í™˜ê²½ ì§€ì›**: Redis ê¸°ë°˜ í† í° ì €ì¥ì†Œ ê³ ë ¤
- **í† í° ë¸”ë™ë¦¬ìŠ¤íŠ¸**: ê°•ì œ ë¡œê·¸ì•„ì›ƒì„ ìœ„í•œ í† í° ë¬´íš¨í™” ê¸°ëŠ¥
- **ê°ì‚¬ ë¡œê·¸**: í† í° ìƒì„±/ì‚­ì œ ì´ë²¤íŠ¸ ë¡œê¹…

## ë‹¤ìŒ ë‹¨ê³„ (FT-009)

### ì—°ê³„ ì‘ì—…
- **JWT ì¸ì¦ í•„í„°**: Spring Securityì™€ RefreshToken í†µí•©
- **í† í° ê²€ì¦ ë¡œì§**: Access Token ê²€ì¦ ì‹œ RefreshToken í™œìš©
- **í† í° ê°±ì‹  í”Œë¡œìš°**: ë§Œë£Œëœ Access Token ê°±ì‹  í”„ë¡œì„¸ìŠ¤

### ì˜ì¡´ì„±
- **FT-007 ì™„ë£Œ**: JWT í† í° ìœ í‹¸ë¦¬í‹° (âœ… ì™„ë£Œ)
- **FT-008 ì™„ë£Œ**: RefreshToken ì €ì¥ì†Œ (âœ… ì™„ë£Œ)
- **FT-009 ì§„í–‰**: JWT ì¸ì¦ í•„í„° êµ¬í˜„

## ì‹œë‹ˆì–´ ê°œë°œì ê´€ì ì˜ ì¶”ê°€ ì„¤ëª…

### ì•„í‚¤í…ì²˜ ì„¤ê³„ ê³ ë ¤ì‚¬í•­
RefreshToken ì €ì¥ì†ŒëŠ” JWT ì¸ì¦ ì‹œìŠ¤í…œì˜ í•µì‹¬ êµ¬ì„±ìš”ì†Œë¡œ, ë‹¤ìŒê³¼ ê°™ì€ ì„¤ê³„ ì›ì¹™ì„ ì ìš©í–ˆìŠµë‹ˆë‹¤:

1. **ë‹¨ì¼ ì±…ì„ ì›ì¹™**: ê° ServiceëŠ” í•˜ë‚˜ì˜ UseCaseë§Œ êµ¬í˜„
2. **ê°œë°©-íì‡„ ì›ì¹™**: í¬íŠ¸ ì¸í„°í˜ì´ìŠ¤ë¥¼ í†µí•´ í™•ì¥ì—ëŠ” ì—´ë ¤ìˆê³  ìˆ˜ì •ì—ëŠ” ë‹«í˜€ìˆìŒ
3. **ì˜ì¡´ì„± ì—­ì „ ì›ì¹™**: ê³ ìˆ˜ì¤€ ëª¨ë“ˆì´ ì €ìˆ˜ì¤€ ëª¨ë“ˆì— ì˜ì¡´í•˜ì§€ ì•ŠìŒ

### í™•ì¥ì„± ê³ ë ¤ì‚¬í•­
- **ë©€í‹° ì„œë²„ í™˜ê²½**: Redis ê¸°ë°˜ ì €ì¥ì†Œë¡œ êµì²´ ì‹œ í¬íŠ¸ ì¸í„°í˜ì´ìŠ¤ë§Œ ë³€ê²½í•˜ë©´ ë¨
- **ì„±ëŠ¥ ìŠ¤ì¼€ì¼ë§**: ì½ê¸° ì „ìš© ë³µì œë³¸ í™œìš© ì‹œ Read/Write í¬íŠ¸ ë¶„ë¦¬ ê°€ëŠ¥
- **ë³´ì•ˆ ê°•í™”**: í† í° ì•”í˜¸í™”, ì‚¬ìš©ì í–‰ë™ ë¶„ì„ ë“± ì¶”ê°€ ê¸°ëŠ¥ í™•ì¥ ìš©ì´

### ìœ ì§€ë³´ìˆ˜ ì‹œ ì£¼ì˜ì‚¬í•­
- **ì‚¬ìš©ìë‹¹ ë‹¨ì¼ í† í°**: ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™ ë³€ê²½ ì‹œ ìŠ¤í‚¤ë§ˆ ë° ë¡œì§ ìˆ˜ì • í•„ìš”
- **ë°°ì¹˜ ì‘ì—…**: ëŒ€ìš©ëŸ‰ ë§Œë£Œ í† í° ì²˜ë¦¬ ì‹œ ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ í•„ìš”
- **íŠ¸ëœì­ì…˜ ê²½ê³„**: Upsert ë™ì‘ì˜ ì¼ê´€ì„±ì„ ìœ„í•´ íŠ¸ëœì­ì…˜ ë²”ìœ„ ìœ ì§€

---

## êµ¬í˜„ ì™„ë£Œ ì²´í¬ë¦¬ìŠ¤íŠ¸

- âœ… **RefreshToken ë„ë©”ì¸ ì—”í‹°í‹° êµ¬í˜„**
- âœ… **Command/Query ê°ì²´ 4ê°œ êµ¬í˜„**
- âœ… **UseCase ì¸í„°í˜ì´ìŠ¤ 3ê°œ êµ¬í˜„**
- âœ… **Service í´ë˜ìŠ¤ 3ê°œ êµ¬í˜„**
- âœ… **ì•„ì›ƒë°”ìš´ë“œ í¬íŠ¸ 3ê°œ êµ¬í˜„**
- âœ… **JPA ì—”í‹°í‹° ë° ë¦¬í¬ì§€í† ë¦¬ êµ¬í˜„**
- âœ… **í†µí•© ì–´ëŒ‘í„° êµ¬í˜„**
- âœ… **ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ 11ê°œ êµ¬í˜„ ë° í†µê³¼**
- âœ… **ì „ì²´ í…ŒìŠ¤íŠ¸ í†µê³¼ (546ê°œ í…ŒìŠ¤íŠ¸)**

**FT-008 RefreshToken ì—”í‹°í‹° ë° í† í° ì €ì¥ì†Œ êµ¬í˜„ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!** ğŸ‰
